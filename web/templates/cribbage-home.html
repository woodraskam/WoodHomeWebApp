<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Woodraska Cribbage - WoodHome</title>
        <link rel="stylesheet" href="/static/css/material-design-3.css">
        <link rel="stylesheet" href="/static/games/WoodraskaCribbage/src/css/styles.css">
        <link rel="stylesheet" href="/static/games/WoodraskaCribbage/src/css/responsive.css">
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    </head>

    <body>
        <div class="cribbage-container">
            <!-- Header -->
            <header class="card">
                <div class="text-center">
                    <h1 class="cribbage-title">üÉè Woodraska Cribbage</h1>
                    <p class="cribbage-body">Classic two-player card game with split-screen play</p>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="card">
                <div class="text-center">
                    <a href="/" class="btn btn-outlined">
                        ‚Üê Back to Dashboard
                    </a>
                </div>
            </nav>

            <!-- Game Options -->
            <div class="grid grid-2">
                <!-- Create Game -->
                <div class="card">
                    <h2 class="cribbage-subtitle">Create New Game</h2>
                    <p class="cribbage-body mb-16">
                        Start a new cribbage game and invite a friend to join.
                    </p>

                    <form class="cribbage-form create-game-form" onsubmit="handleCreateGame(event)">
                        <div class="form-group">
                            <label for="playerEmail" class="form-label">Your Email</label>
                            <input type="email" id="playerEmail" name="playerEmail" class="form-input" required
                                placeholder="your-email@example.com">
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">
                                <span id="create-loading" class="loading hidden">
                                    <span class="loading-spinner"></span>
                                    Creating...
                                </span>
                                <span id="create-text">Create Game</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Join Game -->
                <div class="card">
                    <h2 class="cribbage-subtitle">Join Existing Game</h2>
                    <p class="cribbage-body mb-16">
                        Enter a game ID to join an existing cribbage game.
                    </p>

                    <form class="cribbage-form join-game-form" onsubmit="handleJoinGame(event)">
                        <div class="form-group">
                            <label for="gameId" class="form-label">Game ID</label>
                            <input type="text" id="gameId" name="gameId" class="form-input" required
                                placeholder="Enter game ID">
                        </div>

                        <div class="form-group">
                            <label for="joinPlayerEmail" class="form-label">Your Email</label>
                            <input type="email" id="joinPlayerEmail" name="playerEmail" class="form-input" required
                                placeholder="your-email@example.com">
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-secondary">
                                <span id="join-loading" class="loading hidden">
                                    <span class="loading-spinner"></span>
                                    Joining...
                                </span>
                                <span id="join-text">Join Game</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Game Result -->
            <div id="game-result" class="card hidden">
                <!-- HTMX will populate this with game creation/join results -->
            </div>

            <!-- Game Rules -->
            <div class="card">
                <h2 class="cribbage-subtitle">How to Play</h2>
                <div class="grid grid-2">
                    <div>
                        <h3 class="cribbage-body" style="font-weight: 500; margin-bottom: 12px;">Objective</h3>
                        <p class="cribbage-body">
                            Be the first player to score 121 points by playing cards and counting hands.
                        </p>
                    </div>
                    <div>
                        <h3 class="cribbage-body" style="font-weight: 500; margin-bottom: 12px;">Scoring</h3>
                        <p class="cribbage-body">
                            Score points for 15s, pairs, runs, flushes, and having the Jack of the same suit as the cut
                            card.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Recent Games (if any) -->
            <div class="card">
                <h2 class="cribbage-subtitle">Recent Games</h2>
                <div id="recent-games">
                    <p class="cribbage-body text-center" style="color: var(--cribbage-on-surface); opacity: 0.7;">
                        No recent games found.
                    </p>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="/static/games/WoodraskaCribbage/src/js/main.js"></script>
        <script src="/static/games/WoodraskaCribbage/src/js/gameState.js"></script>
        <script src="/static/games/WoodraskaCribbage/src/js/cribbageLogic.js"></script>
        <script src="/static/games/WoodraskaCribbage/src/js/signalr.js"></script>
        <script src="/static/games/WoodraskaCribbage/src/js/cardAnimations.js"></script>

        <script>
            // Initialize animations
            const animations = new CribbageCardAnimations();
            animations.init();

            // Handle form submissions
            document.addEventListener('DOMContentLoaded', function () {
                // HTMX event handlers removed - using native JavaScript fetch instead
            });

            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-card';
                errorDiv.textContent = message;
                document.getElementById('game-result').appendChild(errorDiv);
                document.getElementById('game-result').classList.remove('hidden');
            }

            function showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success-card';
                successDiv.textContent = message;
                document.getElementById('game-result').appendChild(successDiv);
                document.getElementById('game-result').classList.remove('hidden');
            }

            // Custom form handler for create game
            function handleCreateGame(event) {
                event.preventDefault();

                const form = event.target;

                // Prevent double submission
                if (form.dataset.submitting === 'true') {
                    console.log('Form already submitting, ignoring duplicate submission');
                    return;
                }
                form.dataset.submitting = 'true';

                const formData = new FormData(form);
                const playerEmail = formData.get('playerEmail');

                console.log('Creating game for:', playerEmail);

                // Show loading and disable submit button
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Creating...';
                }

                const loadingElement = form.querySelector('.loading');
                const textElement = form.querySelector('.loading').nextElementSibling;
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (textElement) textElement.classList.add('hidden');

                // Make API call
                fetch('/api/cribbage/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ playerEmail: playerEmail })
                })
                    .then(response => {
                        console.log('Raw response:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('API Response:', data);
                        console.log('Data structure:', JSON.stringify(data, null, 2));

                        // Hide loading
                        if (loadingElement) loadingElement.classList.add('hidden');
                        if (textElement) textElement.classList.remove('hidden');

                        if (data.status === 'success' && data.data) {
                            const gameId = data.data.gameId;
                            const playerEmail = data.data.playerEmail;

                            console.log('Game created - ID:', gameId, 'Email:', playerEmail);
                            console.log('gameId type:', typeof gameId, 'value:', gameId);
                            console.log('playerEmail type:', typeof playerEmail, 'value:', playerEmail);

                            if (gameId && playerEmail) {
                                const redirectUrl = `/play/WoodraskaCribbage/board/?gameId=${gameId}&playerEmail=${encodeURIComponent(playerEmail)}`;
                                console.log('Redirecting to:', redirectUrl);
                                window.location.href = redirectUrl;
                            }
                        } else {
                            showError(data.message || 'Failed to create game');
                            form.dataset.submitting = 'false'; // Reset flag on error

                            // Re-enable button on error
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.textContent = 'Create Game';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showError('An error occurred. Please try again.');

                        // Hide loading
                        if (loadingElement) loadingElement.classList.add('hidden');
                        if (textElement) textElement.classList.remove('hidden');

                        // Reset submission flag on error
                        form.dataset.submitting = 'false';

                        // Re-enable button on error
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Create Game';
                        }
                    });
            }

            // Custom form handler for join game
            function handleJoinGame(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);
                const gameId = formData.get('gameId');
                const playerEmail = formData.get('playerEmail');

                console.log('Joining game:', gameId, 'for:', playerEmail);

                // Show loading
                const loadingElement = form.querySelector('.loading');
                const textElement = form.querySelector('.loading').nextElementSibling;
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (textElement) textElement.classList.add('hidden');

                // Make API call
                fetch('/api/cribbage/join', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ gameId: gameId, playerEmail: playerEmail })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('API Response:', data);

                        // Hide loading
                        if (loadingElement) loadingElement.classList.add('hidden');
                        if (textElement) textElement.classList.remove('hidden');

                        if (data.status === 'success' && data.data) {
                            const gameId = data.data.gameId;
                            const playerEmail = data.data.playerEmail;

                            console.log('Game joined - ID:', gameId, 'Email:', playerEmail);

                            if (gameId && playerEmail) {
                                const redirectUrl = `/play/WoodraskaCribbage/board/?gameId=${gameId}&playerEmail=${encodeURIComponent(playerEmail)}`;
                                console.log('Redirecting to:', redirectUrl);
                                window.location.href = redirectUrl;
                            }
                        } else {
                            showError(data.message || 'Failed to join game');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showError('An error occurred. Please try again.');

                        // Hide loading
                        if (loadingElement) loadingElement.classList.add('hidden');
                        if (textElement) textElement.classList.remove('hidden');
                    });
            }
        </script>
    </body>

</html>